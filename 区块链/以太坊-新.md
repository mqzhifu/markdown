


# 节点 网络


一个节点需要运行两种客户端软件：
执行客户端：侦听网络中广播的新交易，并在以太坊虚拟机中执行它们，并保存所有当前以太坊数据的最新状态和数据库。

共识客户端：实现权益证明共识算法，使网络能够根据来自执行客户端的经验证数据达成一致。 此外还有名为“验证者”的第三种软件，它们可被添加到共识客户端中，使节点能参与保护网络安全。


全节点：
- 完整的数据，从创世块开始
- 近期的区块开始(随着区块变多，删除旧数据)
轻节点：只下载区块头，而不会下载每个区块。当有数据过来时，可以请求全节点帮忙验证
归档节点：保留完整的区块数据(从创世块开始)并不删除

开源执行客户端程序：Geth  EthereumJS Reth 

网络与服务发现（kad协议）：

- 系统启动后，随机生成本机NodeID，记为LocalID，并且此后不会变化。
- 系统读取公共节点信息，PING,PONG命令完成后，即证明该公共节点存活，将公共节点信息写入本机节点的K桶。
- 系统每隔7200ms执行一次K桶刷新流程。

P2P:节点在发现到自己的邻居节点后，就可以进行节点之间的通信了


# 账户

>对比比特币的"UTXO"余额模型，以太坊使用“账户”余额模型。

#### 外部账户 Externally Owned Account, EOA

通过私钥创建。一把私钥 与该私钥对应的公开地址来表示（由人控制），没有关联任何代码。

1. 拥有以太余额。
2. 能发送交易，包括转账和执行合约代码。
3. 被私钥控制。
4. 没有相关的可执行代码。


#### 合约账户 Contract Account, CA

没有私钥 ，仅有公开的地址。该类账户被它们的合约代码控制且有代码与之关联。
被外部账户或者合约创建，合约在创建时被自动分配到一个账户地址,合约账户地址是通过SHA3哈希算法产生，而非私钥。只能通过外部账户来驱动合约执行合约代码。

1. 拥有以太余额。
2. 有相关的可执行代码（合约代码）。
3. 合约代码能够被交易或者其他合约消息调用。
4. 合约代码被执行时可再调用其他合约代码。
5. 合约代码被执行时可执行复杂运算，可永久地改变合约内部的数据存储。

> 以太坊的数据是以账号为单位进行组织，数据变更驱动账号发生变更，同时引直账号状态发生变更，最后，以太坊状态机发生变更

#### 账户结构体

```
type Account struct {
    Nonce    uint64
    Balance  *big.Int
    Root     common.Hash
    CodeHash []byte
}
```

|  键值| 解释 |  |
|:---|:---|:---|
| Nonce | 自增ID，防双花。起始0，每一次触发操作(交易)，自动加1 |  |
| Balance | 记录该账户所拥有的以太（ETH）数量 |  |
| CodeHash | 指向(账户)代码片段 |  |
| Root | 指向一个merker树->account storage，也叫存储hash |  |
|  |  |  |  

外部账户不包含合约，所以 ROOT 和 CodeHash 值为空
>从这两个字段值也可以判断出：外部账户 合约账户


公开地址  ----link---> 账户状态


# 交易

分类：
- 以太币转账
- 智能合约调用
- 智能合约创建



一次交易数据：

```
{
  nonce: web3.toHex(10),
  GasPrice: web3.toHex(100000000000),
  Gas: web3.toHex(140000),
  from: '0x633296baebc20f33ac2e1c1b105d7cd1f6a0718b',
  to: '0xD1E1cdbCE15f1009B5A7874053E09C728Df91d47',
  value: web3.toHex(0),
  data: '0xcc9ab24952616d6100000000000000000000000000000000000000000000000000000000'
}
```

|          key     |      value                                                   |
|---------------|---------------------------------------------------------|
|nonce          |由始发EOA（外部所有账户）发出的序列号，用于防止消息重播。|
|from|发送者(外部账号)的地址，该地址将签署交易|
|to\(recipient\)|接收账户地址，如果是合约账户，将执行代码                                         |
|value          |太币数量（面值为 WEI，1 个以太币 = 1e+18wei）发送到目标地址的ether数量。                              |
|gas price      |执行每条指令的价格（以wei为单位）                |
|gas limit     |执行交易可使用(消耗)的最大Gas数量                             |
|data           |变长二进制数据。可选，算是交易的附加数据                                         |
|v,r,s          |始发EOA的ECDSA签名的三个组成部分                      |
|signature      |   发送者签名，证明已授权                                                      |


data
- 智能合约调用，则该值包含编码后的函数名和参数的字节码
- 合约创建，则该值包含初始化合约的字节码。

# GAS 燃料 手续费

合约中，会有若干可执行的代码，当发起交易后，需要在矿工的虚拟机上执行这些代码，执行的过程就是消耗矿工的计算机性能，所以得给出相应费用。

gas Price：每条<合约代码>执行时的价格
gas Used：真实的执行了多少条指令
最终：gas Used  * gasPrice = 实际需要支付gas的价格。

Gas Limit：执行过程中，合约有恶意代码，死循环，最多可运行多少条指令
gas price * gas limit = 最高支付燃料费用

Gas Limit  和 gas price 可以随便写，问题：

1. 如果是正常的执行代码，花费并没那么多，会退还到账户中，
2. 如果燃料不够，那么已执行的代码的费用依然要给，最终会失败。

所以，这个值尽量给的比实际多出一点点~但不用无限大。

gas作用:
1. 防止有玩家生成很多交易，造成垃圾计算
2. 防止玩家上传的脚本死循环，得给gas加上限制

交易费 = Gas x GasPrice

无论交易成功与否，你都需要支付燃料费。因为即使失败，矿工依旧为此交易进行校验和计算，消耗了资源。同时你也无法在钱包中直接设置支付多少燃料费，因为实际燃料费是矿工根据计算得出的，并记录在包含此交易的区块中。






# EVM 虚拟机 Ethereum Virtual Machine

执行合约代码
状态更新
执行交易



# 待处理


Radix 树
Merkle 树
Merkle Patricia树

状态机：每个账户，会存储于 MPT 树的叶子节点，任意账户发生状态变更，逐层向上更新hash值

每个区块，都有：
1. 交易树
2. 收据树
3. 区块内容

| 分类      | 域             | 描述               |
|---------|---------------|------------------|
| 区块信息    | Number        | 区块高度编号           |
|         | Timestamp     | Unix 格式的时间戳      |
|         | Hash          | 本区块的哈希值          |
|         | ParentHash    | 前一个区块的哈希值        |
|         | Nonce         | PoW 算法的哈希值       |
|         | ExtraData     | 额外的信息            |
| 树信息     | transRoot     | 交易树的根哈希值         |
|         | stateRoot     | 状态树的根哈希值         |
|         | receiptsRoot  | 收据树的根哈希值         |
|         | LogsBloom     | 该块的关键日志索引集合      |
| 挖矿/矿工信息 | Miner         | 挖掘该块的矿工账户地址      |
|         | gasLimit      | 当前块允许包容的最大 gas 值 |
|         | Difficulty    | 当前块的挖矿难度值        |
|         | totDifficulty | 区块链的总难度值         |
|         | Size          | 当前块长度(以Byte为单位)  |
| 区块信息    | Sha3uncles    | 叔块列表的哈希值         |
|         | Uncles        | 所引用的叔块列表         |
|         | Transactions  | 所包含交易列表          |
