
# 域名

在网络中，想要互相访问得使用网络传输协议TCP/IP，IP层是使用4组数字，但实在难记住，最好能有些字母单词，比较符合人类的认识，于是就有了域名 

世界上第一个注册的域名是在1985年1月注册的

## 域名组成规则

自定义的子域名串 + 自己申请的字段串 + 顶级域名(域名分类) + 根域名

### 根域名

就是一个点：. ，在最右侧
>一般我们做为用户是看不见这个点的，浏览器帮忙做了处理

### 顶级域名(域名分类)

com：Commercial organizations,商业组织,公司
xyz：创意、创新；三维空间与无限可能
net：Network operations and service centers,网络服务商
tech：科技、技术
org：Other organizations,非盈利组织
gov：Governmental entities,政府部门
edu：Educational institutions,教研机构
cn:中国


### 自己申请的字段串

数字+字母(汉字、中横线)+后缀组成，不区分大小写，一个类似标识符的字符串的东西。
>最长度是255，实际能短则短，目的就是为了替换IP，好识别，方便记住

如：baidu  google apache 

这个就是做为用户、客户的主域名

### 自定义的子域名串

字符串的规则跟上面差不多，也叫子域名。不过得先申请主域名，才可以自定义子域名


## 小结

根域名、域名分类 这两个我们是不能动的，由域名组织定义的，申请的时候就是已知的。根域名大多用不上，即使开发人员很多都不知道这个根域名。

我们日常使用的，大多都是在子域名+主域名是操作


# DNS

Domain Name System，域名系统

它的整个运行机制(核心)是：某台服务器，管理了一堆文本记录，并实现了DNS协议，为请示方(客户端)提供域名相关服务。

## 文本记录/资源 分类 

| 名称   | 解释                                          | 描述                                       |
| ------ | --------------------------------------------- | ------------------------------------------ |
| A记录  | IP记录                                        | 主要操作的就是这个，把域名解析到服务器IP上 |
| CNAME  | 别名                                          | 买3方服务用这个，像：CDN                   |
| MX     | 邮件交换记录                                  | 买3方服务用这个,像：邮件                   |
| TXT    | 记一些文本信息，                              | 可用于 https 证书挑战  之类的              |
| NS     | name server ，指定该域名由哪个DNS服务器来解析 | 我没用过。想把子域名给其它服务器解析       |
| AAAA   | IP6记录                                       |           没用过                                 |
| SOA    | 标识众多NS服务器，哪台才是主的                |        没用过                                    |
| PRT    | 把IP转域名                                    |                                            |
| ...... | ....                                          | 还有几个不常用                             |

NS记录：默认ISP会创建一个(可以有多个)。用户，只能给子域名申请，且目标<解析NS服务器>也只能是域名，NS不能跳转到 CNAME
SOA:系统默认创建,不支持用户创建
## DNS协议

域名解析IP，本地是做不了的(本地缓存除外)，得访问官方组织，得走网络，那就得有一个协议，DNS协议较为简单，TCP/UDP都支持，但好像UDP居多，因为它快/简单，接收方一般开的是53端口(TCP/UDP均能接收 )

![[DNS-报文.png]]


1. ID：16位的消息ID，标示一次正常的交互，该ID由消息请求者设置，消息响应者回复请求时带上该ID。
2. flag：16位的标志位，格式如下：
 ![[dns-flag.png]]
    - QR：占1位，该位为0表示是查询报文，该位为1表示是响应报文
    - opcode：占4位，全是0表示标准查询，全是1表示反向查询，全是2表示服务器状态请求
    - AA：占1位，如果是1表示授权回答，表示该应答是否来自该域的权威服务器
    - TC：占1位，如果是1表示可截断的，即使用UDP时，它表示当应答总长度超过512字节时，只返回前512字节数据
    - RD：占1位，如果是1表示期望递归，可在查询中设置，并在响应中返回，该位设置为1表示使用递归查询，该位设置为0表示使用迭代查询
    - RA：占1位，如果是1表示可用递归，如果名字服务器支持递归查询，可在响应中将该比特位置为1
    - zero：占3位，全部必须设置为0，作为保留位
    - rcode：占4位，表示返回码字段，值为0表示查询的名字没有差错，值为3表示查询的结果有名字差错（域名不存在）

3. 问题数，给请示使用
	- 查询名：要查询的域名，反向查询的话这里是IP
	- 查询类型：资源类型，如:A CNAME
	- 查询类：通常为1，是互联网地址
4. 回答资源记录数：
	1. 域名
	2. 类型
	3. 查询类
	4. TTL(Time To Live,生存周期，域名缓存)
	5. Data length
	6. Data

看协议挺简单，使用UDP也能理解。请示与响应共享一个结构体，响应会多一些数据（记录）信息


测试指令：
- nslookup
- dig




## 域名解析过程

服务器类型：

1. 根
2. 顶级域名
3. 权限（权威）域名

### 根域名服务器

知道所有顶级域名的IP地址
>具说是有：13个IP(不一定是13台机器)，它也存一些映射IP，但好像它更多的是 转发/分发 到顶级域名服务器上，自己不做太多事儿

### 顶级域名服务器

.com .org 这些，在这些顶级域名注册的二级域名，同时保存权限域名服务器IP

### 权限域名服务器：负责一个区，或者是3级域名及以上。

> 感觉像是私有的，比如某公司自己可以搞一个，某个政府/国家也可以搞，跟本地域名服务器有点像呢
> 区好像是域的子集


所有服务器都必须具有一定解析IP的能力，并且能有其它服务器的IP地址。
任何一台服务器都不太可能存储所有的域名IP

## 查找方式

递归、迭代

下面以递归来做DEMO：

![domain-search.png](image/domain-search.png)

## 具体解析过程：

1. 查询本地域名解析，如果有直接返回。
    1. 浏览器缓存\(有时间限制的，根据TTL设置\)
    2. HOST文件\(黑客的最爱,简单有效，域名劫持\)
    3. 本地域名解析服务器，网卡配置文件中的，DNS\-IP（/etc/resolv.conf），黑客依然喜欢
2. 向根服务器发出请求，如果有直接返回。否则，向顶级域名发出请求
3. 顶级域名接收，如果有直接返回。否则，返回失败
4. 最终请求方接收

递归：就是请求方发出一次请求后，等待即可，剩下的是其它各域名服务器之间递归查找
迭代：请求方，发出一次，如果对方未找到IP，会附加的再给你返回下一个域名服务器的IP，请求方需要接着继续找，直接有结果

> 它的这个分布式系统，是真的够松散，会不会有死循环呢？

域名服务器提供哪些类型的服务

|关键字|解释                                                        |
|------|------------------------------------------------------------|
|A     |address, 域名指向IP\(也包括子域名\)，这个是使用最多的       |
|cname |别名，也可以成跳转，就是起个子域名跳转到A域名下             |
|mx    |绑定邮件服务器                                              |
|NS记录|name server,希望由12.34.56.78这台服务器解析news.mydomain.com|



# ICANN

Internet Corporation for Assigned Names and Numbers，

光有域名没用的，必须得有一个权威机构接收你的：申请/注册，且全球唯一。并且提供域名解析成IP的功能

如果全世界就一台服务器，肯定不行，所以就得牵扯到：分布式构架

![domain-tree.png](image/domain-tree.png)



FQDN：Fully Qualified Domain Name，完整主机名 = Hostname（主机名）+ Domain（领域名），根Domain是.（注意最后的”点”） 。