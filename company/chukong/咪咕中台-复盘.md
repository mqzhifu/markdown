# 概览

## 测试服务器

ssh root@114.116.212.202

## 产品文档

https://kxleqzb9u6.feishu.cn/docs/doccnwSzzLFTgf6ikk9Z3Pa0vbg

## 开发语言

- golang
- js(vue)
- unity / c#

## 开源软件

- emqtt
- redis
- mysql
- etcd

# 构架图

![[partygame.png]]

# 核心的东西

1. 游戏前端：正常的 UI 交互操作
2. 游戏后端：帧同步 匹配 房间 数据持久化等
3. 用户中心：注册、登陆、IM、站内信
4. 任务/成就
5. 后台：基础的数据管理、配置及统计等
6. 游戏匹配机制：玩家根据一定自定义规则进行匹配成组
7. 游戏大厅/房间：玩家可进去房间进行游戏前的操作，如：拉人，踢人，创建房间，匹配等
8. 好友/粉丝
   .......

# 产品文档分析

1. 游戏前端/游戏后端
2. 中台

> 这里主要讲述分析的是中台，游戏的前后端因未涉及到，不做讲解

# 中台：

## 从 GIT 仓分析

1. 匹配
   http://192.168.1.22:40080/service/partygame/gamematch
2. 后台管理-后端
   http://192.168.1.22:40080/service/partygame/adminserver.git
3. 后台管理-前端
   http://192.168.1.22:40080/service/partygame/adminweb.git
4. 基础服务中心，如：用户中心、任务、成就、站内信等，都是短连接
   http://192.168.1.22:40080/service/partygame/accountserver.git
5. 房间服务/消息中心，接收 UNITY 后端发送的 mqtt 消息，创建房间，与匹配服务进行通信
   http://192.168.1.22:40080/service/partygame/msgServer.git

> 其中 2 和 3，是可以合成一个项目的，所以，最大的方向看，一共是 4 个微服务

## 从功能模块上看

1. Room：房间服务大厅服务，长连接(与 unity 后端通信)，使用的 mqtt 协议及管理软件，主要功能：组队、mqtt 长连接、IM 消息收发
2. 匹配：对玩家进行分组匹配，主要与 room 通信
3. 帧同步：长连接，对玩家在一局游戏的动作、释放技能等同步，（简单的囚徒锁模式）
4. 管理后台：管理整个游戏的：配置信息、用户信息、黑词、举报、认识、基础统计、订单统计等，辅助完成日常运营 。node + vue + go
5. 用户中心：注册/登陆/、任务、邮件(站内信)、道具、成就、好友、粉丝、订单、支付、货币消耗、存档、站内信、签到等

> 这里多了一个帧同步：仅是提交，未使用

# 从角色顺序讲解

1. 管理员是先在后台把各种配置信息配置好，然后就是等待玩家进入了
2. 游戏后端同时启动，会有多进程，之后把多进程的 IP:PORT 写入到 etcd 中，供 msg service 创建组时使用，接着启动 mqttSdk 等待服务
3. 玩家进入，肯定是先从游戏的前端开始，前端会初始化数据（调用 account 服务），一切 OK 后，等待玩家进入房间
4. 玩家进入房间会做各种设置(房间)操作，这个时候大部分的操作都是请求后端的 msg server 完成（均是 http 短连接）
5. msg service 接收到房间的创建后，会订阅一个 mqtt 的频道，用于：房间玩家广播消息（这里就是长连接了）
6. 玩家开始报名，会调用 msg service ，msg service 调用 match service ， msg service 等待 match service 回调
7. 匹配成功后，准备开始游戏时， msg service 会去第 2 步里，取出空闲的 IP:PORT，统一推送给游戏前端
8. 游戏前端拿到 ip:port 建立长连接，开始帧同步

## 分析

- 核心的服务 msg service ，
- account 更偏向短连接的各种数据获取与设定
- 匹配服务更仅仅是与 msg service 做个数据通信

# msg service

1. 与游戏后端通信
2. 与匹配服务通信
3. 使用了 mqtt 消息长连接

在与两个服务的通信中，其中 90%都是短连接，而长连接承载的功能是：

## 长连接功能：

1. 好友/粉丝 的申请与拒绝
2. IM 消息推送
3. 在线用户列表及用户在线判断

# etcd

4 个服务及游戏后端的，公共通信都用了 etcd，或者间接的使用了 etcd，所以单独拿出来讲讲

## 用途

- 服务发现
  > 每个服务启动均会到 etcd 里注册 IP:PORT，且注册 watch，这样服务间互相通信都是动态的，即保证安全，又可以动态扩容
- 数据变更
  > 当某一服务用到另一服务的一些数据时，一但另外的数据发生变更后，使用者会第一时间被通知，可做相应的容错处理
- 中转/临时数据
  > 两端通信时，需要的一些数据，可暂存在这里，两端不用直接通信，用 ETCD 做中转，扩展及稳定性更好一些

# 游戏后端

因为是黑盒，大部分不清楚，只把已知的写出来

> 由对方开发，且一直都是王曦与他交流

玩家匹配流程：

1. 游戏后端会先开 10~20 个守护进程，可能是用于帧同步服务
2. 每个进程会把自己的 IP:PORT 写到 ETCD 中
3. 房间服务、匹配服务成功后，用户需要与这些进程建立连接，于是去 etcd 中读取这些进程配置信息
4. 进程的配置信息及进程的当前一些状态，是由游戏后端控制，一但有变动 ，会通知 etcd
5. etcd 会反向通知给 msg server ，这样游戏后端与中台还是保持着一定的实时性
6. 当拿到 IP PORT 后，msg server 会把数据发送到 mqtt 中
7. 前端订阅了 mqtt 的管道，于是也能顺意拿到 IP:PORT，开始建立连接
8. 到此，游戏已经正式开始，基本上没中台什么事儿了

# 游戏前端

可以找冯凯要个安装包，有 APK 也有 MAC 版的，这里依然是黑盒，对比着 APP，写点日常操作吧

1. 玩家进入后，会有一些基础的操作，如：签到、任务、邮件、登陆注册这些。
2. 创建角色的时候，可以做一些人物 DIY 掐脸:面部 头发 化妆 体形 皮肤等
3. 可自行创建房间，通过 IM，邀请好友一起参与匹配
4. 也可以快速匹配
5. 匹配成功后，选择地图，游戏开始
6. 我进去玩了会，有点类似 NS 上的《喷射战士》，组团射击类的游戏，可以使用些道具

# 复用率

如果对项目没扩展性、高并发 要求，项目较小，里面的模块功能其实也都有，再做拆分也还可以，改一改，能用的东西还是不少的

## 详细分析

针对中台的几个微服务和功能模块，做不同定位与分析

### 用户中心

- 注册登陆
- 任务
- 站内信
- 成就

这些比较基础的，其实可以给很多项目复用，或者当做一个基础，让使用者再做一些二次开发，

但有些确实功能不全，如：

- 3 方登陆没有
- 登陆注册仅限咪咕
- 邮件手机注册貌似功能也不太全
- 找回密码好像没有等等吧
- 剩下的：
- 站内信
- 任务
- 成就
- 这些

基本上能复用

### IM

借助 mqtt 实现，强依赖 emqtt 软件，也可以当做消息\(不是 APP 推送，是 APP 内部的一些消息\)推送，如没特殊的修改化要求 ，其实可以复用。

### 好友/粉丝

可以复用

### 商品

这个比较简单，要是想要电商的那套东西，这里肯定不能利用

### 订单

跟上面差不多，也是比较简单，利用率不太高

### 支付

这个基本上不可复用，因为好像只接了咪咕的支付，像：微信 支付宝都没有，并且未使用工厂模式，二次开发也没什么意义

### 渠道/平台/游戏体系

跟字面的意思不太一样，以我之前做小游戏来看，平台或渠道都是下面可挂多个游戏，设计之初就是为多游戏而生的，且一些逻辑及统计均用到平台这个概念。而这个中台，在编写之初，就是主要服务于单一游戏的，后期加的渠道跟平台，功能简单，也只是加了个 flag，好像没太多实际的作用

### 基础统计

跟上面差不多，如果拿小游戏的各种统计指标来看，后台的统计不仅项目少，而且感觉并不是特别专业的数据分析

### 匹配

基本上可以复用，可能不同游戏有不同的规则，在权重这块可以做二次开发。另外，仅支持 5V5，想做 6V6 还得开发

### 服务发现

并未做封装，只是简单的实现了一下，不存在复用这个概念

### 队伍/房间管理

可复用

### 大厅管理

不存在大厅这个概念

### 后台管理的框架

可复用，像：菜单 权限 这些可以复用，因为这个后台本就是网上一个团队专门开发并开源的，叫 gin-vue-admin

### 帧同步

小项目，基本可复用，大项目，大数据及大业务来看，可能复用率不高，像：没有 预测回滚、对长连接的稳定性控制（移动 联通 PC H5 不同场景）

## 复用率总结

中台的所有代码，都有一个共同的问题：没经过实践、大数据的考验，上面的复用率仅是单从功能上分析 ，而如果数据量变大，业务量变大，可复用率就是未知了，这里也包括我的：匹配、帧同步未经实践考验。

### 优点

1. 模块的拆分还是比较具体的，如：游戏组就负责游戏的东西，如：帧同步(游戏后端) UI 交互(游戏前端)，中台组处理 DB 持久化，消息通知等，每个服务拆开都可以任意部署
2. 功能的话还算是全，如：用户中心 任务 成就 消息 等这些基本上都有，小项目的话，可以考虑直接用或者改一改
3. 项目简单，并没有用到过多的中间件及其它开源的软件，查错 部署略简单

### 缺点

1. 没有 CICD 自动化部署
2. 缺少帧同步
3. 缺少游戏的代码
4. 项目代码还未真的微服务进行编写，扩展性、高并发 可能略差一点
5. 配套的微服务体系还是缺少一些，如：ES(日志) ALERTMANAGER(报警) PROMETHEUS(指标数据收集) zipkin(链路追踪) kafaka(消息队列) 等

# 总结

看似是个挺大的游戏，实则没多少东西，核心的应该是 UNITY/C#写的游戏，至于：中台、后台基本上全是 CURD 没啥技术含量。

另外，比较可惜的是：有项目可做，中台、后台完全可以做的更强、更通用化，但实际情况是基本上就是为了做而做。大多未考虑扩展性。
